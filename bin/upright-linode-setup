#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="${SCRIPT_DIR}/../lib/upright"

SCRIPT_NAME="$(basename "$0")"
STATE_PATH="infra/state.json"
STACKSCRIPT_PATH="scripts/stackscript/upright-bootstrap.sh"

DRY_RUN=false
RESUME=false
DESTROY=false
NON_INTERACTIVE=false
AUTO_APPROVE=false

LINODE_PAT=""
ROOT_DOMAIN=""
UPRIGHT_SUFFIX=""
PLAN_MODE=""
INSTANCE_TYPE="g6-standard-2"
IMAGE="linode/ubuntu24.04"
DEPLOY_USER="deploy"
SSH_PORT="2222"
DNS_MODE=""
REGION_MODE=""
REGISTRY_SERVER="ghcr.io"
REGISTRY_USERNAME="your-github-username"
IMAGE_NAME="ghcr.io/your-github-username/upright"
SSH_PUBKEY_PATH=""
SSH_PUBKEY_VALUE=""
SSH_KEY_SOURCE=""
SSH_KEY_IDS=""
STACKSCRIPT_LABEL="upright-bootstrap"
STACKSCRIPT_ID=""
CLOUDFLARE_API_TOKEN=""
CLOUDFLARE_ZONE_ID=""
CURRENT_PHASE=""
RUN_DEPLOY=""
MANUAL_DNS_CONFIRMED=false
CONFIRM_DESTROY_FLAG=false
DELETE_STACKSCRIPT=false
OUTPUT_JSON=""

APP_REGION=""
ORD_REGION=""
IAD_REGION=""
SEA_REGION=""
APP_REGION_LABEL=""
ORD_REGION_LABEL=""
IAD_REGION_LABEL=""
SEA_REGION_LABEL=""
PLAN_TYPES_JSON=""
PROVISION_MODE="classic"
ROOT_DOMAIN_SELECTED_FROM_LINODE=false

if [[ -t 1 ]]; then
  C_RESET=$'\033[0m'
  C_BOLD=$'\033[1m'
  C_BLUE=$'\033[34m'
  C_CYAN=$'\033[36m'
  C_GREEN=$'\033[32m'
  C_YELLOW=$'\033[33m'
  C_RED=$'\033[31m'
  C_DIM=$'\033[2m'
else
  C_RESET=""
  C_BOLD=""
  C_BLUE=""
  C_CYAN=""
  C_GREEN=""
  C_YELLOW=""
  C_RED=""
  C_DIM=""
fi

source "${LIB_DIR}/ui.sh"
source "${LIB_DIR}/preflight.sh"
source "${LIB_DIR}/inputs.sh"
source "${LIB_DIR}/planning.sh"
source "${LIB_DIR}/state.sh"
source "${LIB_DIR}/provision.sh"
source "${LIB_DIR}/dns.sh"
source "${LIB_DIR}/deploy.sh"
source "${LIB_DIR}/destroy.sh"
source "${LIB_DIR}/output.sh"
source "${LIB_DIR}/flow.sh"

main "$@"
