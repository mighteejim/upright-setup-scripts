---
- name: Bootstrap Upright Rails app
  when: upright_bootstrap_app | default(true) | bool
  block:
    - name: Validate app bootstrap inputs
      ansible.builtin.assert:
        that:
          - (upright_app_path | default('/home/' ~ deploy_user ~ '/upright', true)) | length > 0
          - (upright_ruby_version | default('3.4.2', true)) | length > 0
          - (upright_rails_version | default('8.1.2', true)) | length > 0
          - app_public_ipv4 | default('') | length > 0
          - monitor_nodes is defined
          - (monitor_nodes | length) >= 3
          - (image_name | default('', true)) | length > 0
          - (registry_server | default('ghcr.io', true)) | length > 0
          - (registry_username | default('', true)) | length > 0
          - (registry_username | default('', true)) != 'your-github-username'
          - "'your-github-username' not in (image_name | default('', true))"
        fail_msg: Missing required app bootstrap variable(s)

    - name: Install app bootstrap packages
      ansible.builtin.apt:
        name:
          - autoconf
          - bison
          - build-essential
          - libdb-dev
          - libffi-dev
          - libgdbm-dev
          - libncurses5-dev
          - libreadline-dev
          - libssl-dev
          - libyaml-dev
          - zlib1g-dev
        state: present
        lock_timeout: 600
      register: app_bootstrap_apt_result
      retries: 20
      delay: 10
      until: app_bootstrap_apt_result is succeeded

    - name: Ensure app parent directory exists
      ansible.builtin.file:
        path: "{{ (upright_app_path | default('/home/' ~ deploy_user ~ '/upright', true)) | dirname }}"
        state: directory
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: "0755"

    - name: Install rbenv for deploy user
      become_user: "{{ deploy_user }}"
      ansible.builtin.git:
        repo: https://github.com/rbenv/rbenv.git
        dest: "/home/{{ deploy_user }}/.rbenv"
        update: true

    - name: Install ruby-build plugin for rbenv
      become_user: "{{ deploy_user }}"
      ansible.builtin.git:
        repo: https://github.com/rbenv/ruby-build.git
        dest: "/home/{{ deploy_user }}/.rbenv/plugins/ruby-build"
        update: true

    - name: Ensure rbenv env setup in deploy profile
      ansible.builtin.blockinfile:
        path: "/home/{{ deploy_user }}/.profile"
        create: true
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: "0644"
        marker: "# {mark} UPRIGHT_RBENV"
        block: |
          export RBENV_ROOT="$HOME/.rbenv"
          export PATH="$RBENV_ROOT/bin:$PATH"
          eval "$(rbenv init - bash)"

    - name: Install and activate Ruby via rbenv
      become_user: "{{ deploy_user }}"
      ansible.builtin.shell: |
        set -euo pipefail
        export RBENV_ROOT="$HOME/.rbenv"
        export PATH="$RBENV_ROOT/bin:$PATH"
        eval "$(rbenv init - bash)"
        rbenv install -s "{{ upright_ruby_version | default('3.4.2', true) }}"
        rbenv global "{{ upright_ruby_version | default('3.4.2', true) }}"
        rbenv rehash
      args:
        executable: /bin/bash

    - name: Install Bundler and Rails gems for bootstrap Ruby
      become_user: "{{ deploy_user }}"
      ansible.builtin.shell: |
        set -euo pipefail
        export RBENV_ROOT="$HOME/.rbenv"
        export PATH="$RBENV_ROOT/bin:$PATH"
        eval "$(rbenv init - bash)"
        rbenv shell "{{ upright_ruby_version | default('3.4.2', true) }}"
        if ! gem list -i bundler >/dev/null; then
          gem install --no-document bundler
        fi
        if ! gem list -i rails -v "{{ upright_rails_version | default('8.1.2', true) }}" >/dev/null; then
          gem install --no-document rails -v "{{ upright_rails_version | default('8.1.2', true) }}"
        fi
        rbenv rehash
      args:
        executable: /bin/bash

    - name: Scaffold Rails app when missing
      become_user: "{{ deploy_user }}"
      ansible.builtin.shell: |
        set -euo pipefail
        export RBENV_ROOT="$HOME/.rbenv"
        export PATH="$RBENV_ROOT/bin:$PATH"
        eval "$(rbenv init - bash)"
        rbenv shell "{{ upright_ruby_version | default('3.4.2', true) }}"
        if [[ ! -f "{{ upright_app_path | default('/home/' ~ deploy_user ~ '/upright', true) }}/Gemfile" ]]; then
          rails _{{ upright_rails_version | default('8.1.2', true) }}_ new "{{ upright_app_path | default('/home/' ~ deploy_user ~ '/upright', true) }}" --database=sqlite3 --skip-test
        fi
      args:
        executable: /bin/bash

    - name: Install Upright gem and initialize app
      become_user: "{{ deploy_user }}"
      ansible.builtin.shell: |
        set -euo pipefail
        export RBENV_ROOT="$HOME/.rbenv"
        export PATH="$RBENV_ROOT/bin:$PATH"
        eval "$(rbenv init - bash)"
        rbenv shell "{{ upright_ruby_version | default('3.4.2', true) }}"
        cd "{{ upright_app_path | default('/home/' ~ deploy_user ~ '/upright', true) }}"
        if ! grep -Eq '^[[:space:]]*gem[[:space:]]+["'"'"']upright["'"'"']' Gemfile; then
          bundle add upright
        fi
        bundle install
        if [[ ! -f config/initializers/upright.rb ]]; then
          bin/rails generate upright:install --force
        fi
        bin/rails db:prepare
        bin/rails db:migrate
      args:
        executable: /bin/bash

    - name: Keep generated Upright host rules additive (do not overwrite)
      ansible.builtin.replace:
        path: "{{ upright_app_path | default('/home/' ~ deploy_user ~ '/upright', true) }}/config/initializers/upright.rb"
        regexp: '(config\.hosts\s*)='
        replace: '\1+='
      failed_when: false

    - name: Resolve monitor public IPv4 addresses for config templates
      ansible.builtin.set_fact:
        app_bootstrap_ord_public_ipv4: "{{ (monitor_nodes | selectattr('code', 'equalto', 'ord') | first).ipv4_public }}"
        app_bootstrap_iad_public_ipv4: "{{ (monitor_nodes | selectattr('code', 'equalto', 'iad') | first).ipv4_public }}"
        app_bootstrap_sea_public_ipv4: "{{ (monitor_nodes | selectattr('code', 'equalto', 'sea') | first).ipv4_public }}"

    - name: Build fqdn + host facts for Kamal/Upright config
      ansible.builtin.set_fact:
        app_bootstrap_suffix_fqdn: "{{ ((root_domain | default('') | trim | length) > 0) | ternary(upright_suffix_label ~ '.' ~ root_domain, upright_suffix_label) }}"
        app_bootstrap_app_host: "{{ ((root_domain | default('') | trim | length) > 0) | ternary('app.' ~ upright_suffix_label ~ '.' ~ root_domain, app_public_ipv4) }}"
        app_bootstrap_ord_host: "{{ ((root_domain | default('') | trim | length) > 0) | ternary('ord.' ~ upright_suffix_label ~ '.' ~ root_domain, app_bootstrap_ord_public_ipv4) }}"
        app_bootstrap_iad_host: "{{ ((root_domain | default('') | trim | length) > 0) | ternary('iad.' ~ upright_suffix_label ~ '.' ~ root_domain, app_bootstrap_iad_public_ipv4) }}"
        app_bootstrap_sea_host: "{{ ((root_domain | default('') | trim | length) > 0) | ternary('sea.' ~ upright_suffix_label ~ '.' ~ root_domain, app_bootstrap_sea_public_ipv4) }}"

    - name: Allow Kamal health checks + deployment hosts in Rails production
      ansible.builtin.blockinfile:
        path: "{{ upright_app_path | default('/home/' ~ deploy_user ~ '/upright', true) }}/config/environments/production.rb"
        marker: "  # {mark} UPRIGHT_KAMAL_HOSTS"
        insertbefore: '^end$'
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: "0644"
        block: |
          # Allow Kamal container-id host header health checks during rollout.
          config.hosts << /\A[a-z0-9]{12}(?::\d+)?\z/
          config.hosts << "{{ app_bootstrap_app_host }}"
          config.hosts << "{{ app_bootstrap_ord_host }}"
          config.hosts << "{{ app_bootstrap_iad_host }}"
          config.hosts << "{{ app_bootstrap_sea_host }}"
          config.hosts << "{{ app_public_ipv4 }}"
          config.hosts << "{{ app_bootstrap_ord_public_ipv4 }}"
          config.hosts << "{{ app_bootstrap_iad_public_ipv4 }}"
          config.hosts << "{{ app_bootstrap_sea_public_ipv4 }}"

    - name: Ensure .kamal directory exists
      ansible.builtin.file:
        path: "{{ upright_app_path | default('/home/' ~ deploy_user ~ '/upright', true) }}/.kamal"
        state: directory
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: "0755"

    - name: Write Kamal deploy config from cluster metadata
      ansible.builtin.template:
        src: deploy.yml.j2
        dest: "{{ upright_app_path | default('/home/' ~ deploy_user ~ '/upright', true) }}/config/deploy.yml"
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: "0644"

    - name: Write Upright sites config
      ansible.builtin.template:
        src: sites.yml.j2
        dest: "{{ upright_app_path | default('/home/' ~ deploy_user ~ '/upright', true) }}/config/sites.yml"
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: "0644"

    - name: Write Kamal secrets template
      ansible.builtin.template:
        src: kamal-secrets.j2
        dest: "{{ upright_app_path | default('/home/' ~ deploy_user ~ '/upright', true) }}/.kamal/secrets"
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: "0644"

    - name: Ensure app repo has initial git commit for Kamal
      become_user: "{{ deploy_user }}"
      ansible.builtin.shell: |
        set -euo pipefail
        changed=0
        cd "{{ upright_app_path | default('/home/' ~ deploy_user ~ '/upright', true) }}"
        if [[ ! -d .git ]]; then
          git init >/dev/null
        fi
        if ! git rev-parse --verify HEAD >/dev/null 2>&1; then
          git add -A
          git config user.name >/dev/null 2>&1 || git config user.name "Upright Bootstrap"
          git config user.email >/dev/null 2>&1 || git config user.email "deploy@$(hostname -f 2>/dev/null || hostname)"
          if ! git diff --cached --quiet --ignore-submodules --; then
            git commit -m "chore: bootstrap upright app" >/dev/null
            changed=1
          fi
        fi
        echo "changed=${changed}"
      args:
        executable: /bin/bash
      register: app_bootstrap_git_commit
      changed_when: "'changed=1' in app_bootstrap_git_commit.stdout"
