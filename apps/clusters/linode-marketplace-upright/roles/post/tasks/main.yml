---
- name: Write credentials and next-step notes
  ansible.builtin.copy:
    dest: "/home/{{ deploy_user }}/.credentials"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: "0600"
    content: |
      Upright cluster bootstrap complete.

      Deploy user: {{ deploy_user }}
      Upright app path: {{ upright_app_path | default('/home/' ~ deploy_user ~ '/upright', true) }}
      App bootstrap: {{ (upright_bootstrap_app | default(true) | bool) | ternary('enabled', 'disabled') }}
      Image: {{ image_name | default('ghcr.io/your-github-username/upright', true) }}
      Registry: {{ registry_server | default('ghcr.io', true) }} ({{ registry_username | default('your-github-username', true) }})
      Root domain: {{ root_domain }}
      Suffix label: {{ upright_suffix_label }}

      {% if root_domain | length > 0 %}
      App endpoint: app.{{ upright_suffix_label }}.{{ root_domain }}
      Monitor endpoints:
      {% if monitor_nodes is defined %}
      {% for node in monitor_nodes %}
      - {{ node.code }}.{{ upright_suffix_label }}.{{ root_domain }} -> {{ node.ipv4_public }}
      {% endfor %}
      {% endif %}
      {% else %}
      App endpoint: {{ app_public_ipv4 }}
      Monitor endpoints:
      {% if monitor_nodes is defined %}
      {% for node in monitor_nodes %}
      - {{ node.code }} -> {{ node.ipv4_public }}
      {% endfor %}
      {% endif %}
      {% endif %}

      Next steps (run from your workstation):
      1) SSH to app node as {{ deploy_user }}
      {% if upright_bootstrap_app | default(true) | bool %}
      2) Verify app scaffold at {{ upright_app_path | default('/home/' ~ deploy_user ~ '/upright', true) }}
      3) Verify generated config files:
         - {{ upright_app_path | default('/home/' ~ deploy_user ~ '/upright', true) }}/config/deploy.yml
         - {{ upright_app_path | default('/home/' ~ deploy_user ~ '/upright', true) }}/config/sites.yml
         - {{ upright_app_path | default('/home/' ~ deploy_user ~ '/upright', true) }}/.kamal/secrets
      4) Run ~/bin/setup-pass-secrets on app node
      5) Add/load deploy secrets via ~/bin/load-secrets
      6) Run cd {{ upright_app_path | default('/home/' ~ deploy_user ~ '/upright', true) }} && bin/kamal setup && bin/kamal deploy
      {% else %}
      2) Clone/create your Upright Rails app repo at {{ upright_app_path | default('/home/' ~ deploy_user ~ '/upright', true) }}
      3) Run ~/bin/setup-pass-secrets on app node
      4) Add/load deploy secrets via ~/bin/load-secrets
      5) Run cd {{ upright_app_path | default('/home/' ~ deploy_user ~ '/upright', true) }} && bin/kamal setup && bin/kamal deploy
      {% endif %}

- name: Ensure deploy user bin directory
  ansible.builtin.file:
    path: "/home/{{ deploy_user }}/bin"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: "0755"
    state: directory

- name: Install setup-pass-secrets helper
  ansible.builtin.copy:
    src: setup-pass-secrets
    dest: "/home/{{ deploy_user }}/bin/setup-pass-secrets"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: "0755"

- name: Install load-secrets helper
  ansible.builtin.copy:
    src: load-secrets
    dest: "/home/{{ deploy_user }}/bin/load-secrets"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: "0755"

- name: Ensure helper scripts are in deploy user PATH
  ansible.builtin.lineinfile:
    path: "/home/{{ deploy_user }}/.profile"
    line: 'export PATH="$HOME/bin:$PATH"'
    create: true
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: "0644"

- name: Write root cluster summary
  ansible.builtin.copy:
    dest: /root/.upright-cluster-info
    mode: "0600"
    content: |
      cluster_name={{ cluster_name }}
      cluster_uuid={{ cluster_uuid }}
      app_public_ipv4={{ app_public_ipv4 }}
      root_domain={{ root_domain }}
      upright_suffix_label={{ upright_suffix_label }}
      dns_mode={{ dns_mode }}
      {% if monitor_nodes is defined %}
      {% for node in monitor_nodes %}
      {{ node.code }}={{ node.ipv4_public }}
      {% endfor %}
      {% endif %}
