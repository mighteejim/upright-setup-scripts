---
- name: Write credentials and next-step notes
  ansible.builtin.copy:
    dest: "/home/{{ deploy_user }}/.credentials"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: "0600"
    content: |
      Upright cluster bootstrap complete.

      Deploy user: {{ deploy_user }}
      Upright app path: {{ upright_app_path | default('/home/' ~ deploy_user ~ '/upright', true) }}
      App bootstrap: {{ (upright_bootstrap_app | default(true) | bool) | ternary('enabled', 'disabled') }}
      Image: {{ image_name | default('(not set)', true) }}
      Registry: {{ registry_server | default('ghcr.io', true) }} ({{ registry_username | default('(not set)', true) }})
      Root domain: {{ root_domain }}
      Suffix label: {{ upright_suffix_label }}

      {% if root_domain | length > 0 %}
      App endpoint: app.{{ upright_suffix_label }}.{{ root_domain }}
      Monitor endpoints:
      {% if monitor_nodes is defined %}
      {% for node in monitor_nodes %}
      - {{ node.code }}.{{ upright_suffix_label }}.{{ root_domain }} -> {{ node.ipv4_public }}
      {% endfor %}
      {% endif %}
      {% else %}
      App endpoint: {{ app_public_ipv4 }}
      Monitor endpoints:
      {% if monitor_nodes is defined %}
      {% for node in monitor_nodes %}
      - {{ node.code }} -> {{ node.ipv4_public }}
      {% endfor %}
      {% endif %}
      {% endif %}

      Next steps (run from your workstation):
      1) SSH to app node as {{ deploy_user }}
      2) Verify app scaffold at {{ upright_app_path | default('/home/' ~ deploy_user ~ '/upright', true) }}
      3) Verify generated config files:
         - {{ upright_app_path | default('/home/' ~ deploy_user ~ '/upright', true) }}/config/deploy.yml
         - {{ upright_app_path | default('/home/' ~ deploy_user ~ '/upright', true) }}/config/sites.yml
         - {{ upright_app_path | default('/home/' ~ deploy_user ~ '/upright', true) }}/.kamal/secrets
      4) Run eval "$(~/bin/configure-secrets)" on app node
      5) Run cd {{ upright_app_path | default('/home/' ~ deploy_user ~ '/upright', true) }} && bin/kamal setup && bin/kamal deploy
      6) Run ~/bin/verify-probe-scheduler (fails if recurring HTTP probes missing at runtime)
      7) Optional individual helpers live under ~/bin/helpers

- name: Ensure deploy user bin directory
  ansible.builtin.file:
    path: "/home/{{ deploy_user }}/bin"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: "0755"
    state: directory

- name: Ensure deploy user helpers directory
  ansible.builtin.file:
    path: "/home/{{ deploy_user }}/bin/helpers"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: "0755"
    state: directory

- name: Install helper scripts under ~/bin/helpers
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "/home/{{ deploy_user }}/bin/helpers/{{ item }}"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: "0755"
  loop:
    - setup-pass-secrets
    - setup-certbot-ssl
    - load-secrets
    - verify-probe-scheduler

- name: Install configure-secrets wrapper
  ansible.builtin.copy:
    src: configure-secrets
    dest: "/home/{{ deploy_user }}/bin/configure-secrets"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: "0755"

- name: Install compatibility shims in ~/bin
  ansible.builtin.copy:
    dest: "/home/{{ deploy_user }}/bin/{{ item }}"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: "0755"
    content: |
      #!/usr/bin/env bash
      exec "$HOME/bin/helpers/{{ item }}" "$@"
  loop:
    - setup-pass-secrets
    - setup-certbot-ssl
    - load-secrets
    - verify-probe-scheduler

- name: Ensure helper scripts are in deploy user PATH
  ansible.builtin.lineinfile:
    path: "/home/{{ deploy_user }}/.profile"
    line: 'export PATH="$HOME/bin:$PATH"'
    create: true
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: "0644"

- name: Write root cluster summary
  ansible.builtin.copy:
    dest: /root/.upright-cluster-info
    mode: "0600"
    content: |
      cluster_name={{ cluster_name }}
      cluster_uuid={{ cluster_uuid }}
      app_public_ipv4={{ app_public_ipv4 }}
      root_domain={{ root_domain }}
      upright_suffix_label={{ upright_suffix_label }}
      dns_mode={{ dns_mode }}
      {% if monitor_nodes is defined %}
      {% for node in monitor_nodes %}
      {{ node.code }}={{ node.ipv4_public }}
      {% endfor %}
      {% endif %}
