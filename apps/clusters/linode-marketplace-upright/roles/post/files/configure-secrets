#!/usr/bin/env bash
set -euo pipefail

HELPER_DIR="${HOME}/bin/helpers"
UPRIGHT_APP_PATH="${UPRIGHT_APP_PATH:-$HOME/upright}"

need_helper() {
  local path="$1"
  if [[ ! -x "${path}" ]]; then
    echo "[ERROR] Missing helper script: ${path}" >&2
    exit 1
  fi
}

need_helper "${HELPER_DIR}/setup-pass-secrets"
need_helper "${HELPER_DIR}/setup-certbot-ssl"
need_helper "${HELPER_DIR}/load-secrets"

ssl_enabled="${ENABLE_SSL:-}"
if [[ -z "${ssl_enabled}" ]]; then
  if [[ -f "${UPRIGHT_APP_PATH}/config/deploy.yml" ]] && grep -q 'certificate_pem:' "${UPRIGHT_APP_PATH}/config/deploy.yml"; then
    ssl_enabled="true"
  else
    ssl_enabled="false"
  fi
fi

echo "[INFO] Initializing pass secrets (registry/admin)" >&2
"${HELPER_DIR}/setup-pass-secrets" 1>&2

if [[ "${ssl_enabled}" == "true" ]]; then
  echo "[INFO] SSL enabled; running certbot setup (stores PEMs in pass)" >&2
  "${HELPER_DIR}/setup-certbot-ssl" 1>&2
else
  echo "[INFO] SSL disabled; skipping certbot setup" >&2
fi

echo "[INFO] Emitting environment exports from load-secrets" >&2
exec "${HELPER_DIR}/load-secrets"
