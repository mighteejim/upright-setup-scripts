#!/usr/bin/env bash
set -euo pipefail

PASS_PREFIX="${PASS_PREFIX:-upright}"
UPRIGHT_APP_PATH="${UPRIGHT_APP_PATH:-$HOME/upright}"

read_secret() {
  local key="$1"
  local env_name="$2"
  local env_val="${!env_name:-}"
  local pass_val=""
  if ! command -v pass >/dev/null 2>&1; then
    pass_val=""
  else
    pass_val="$(pass show "${PASS_PREFIX}/${key}" 2>/dev/null | head -n1 | tr -d '\r')"
  fi
  if [[ -n "${pass_val}" ]]; then
    if [[ -n "${env_val}" && "${env_val}" != "${pass_val}" ]]; then
      echo "[WARN] ${env_name}: using pass value (env differs)" >&2
    fi
    printf '%s' "${pass_val}"
    return 0
  fi
  if [[ -n "${env_val}" ]]; then
    printf '%s' "${env_val//$'\r'/}"
    return 0
  fi
  return 1
}

read_secret_multiline() {
  local key="$1"
  local env_name="$2"
  local env_val="${!env_name:-}"
  local pass_val=""
  if ! command -v pass >/dev/null 2>&1; then
    pass_val=""
  else
    pass_val="$(pass show "${PASS_PREFIX}/${key}" 2>/dev/null | tr -d '\r')"
  fi
  if [[ -n "${pass_val}" ]]; then
    if [[ -n "${env_val}" && "${env_val}" != "${pass_val}" ]]; then
      echo "[WARN] ${env_name}: using pass value (env differs)" >&2
    fi
    printf '%s' "${pass_val}"
    return 0
  fi
  if [[ -n "${env_val}" ]]; then
    printf '%s' "${env_val//$'\r'/}"
    return 0
  fi
  return 1
}

require_secret() {
  local key="$1"
  local env_name="$2"
  local label="$3"
  local value
  value="$(read_secret "${key}" "${env_name}" || true)"
  if [[ -z "${value}" ]]; then
    echo "[ERROR] Missing secret: ${label}. Run ~/bin/setup-pass-secrets or export ${env_name}." >&2
    exit 1
  fi
  printf '%s' "${value}"
}

KAMAL_REGISTRY_PASSWORD="$(require_secret kamal/registry_password KAMAL_REGISTRY_PASSWORD KAMAL_REGISTRY_PASSWORD)"
ADMIN_PASSWORD="$(require_secret admin_password ADMIN_PASSWORD ADMIN_PASSWORD)"
CERTIFICATE_PEM=""
PRIVATE_KEY_PEM=""
if [[ "${ENABLE_SSL:-}" == "true" ]] || { [[ -f "${UPRIGHT_APP_PATH}/config/deploy.yml" ]] && grep -q 'certificate_pem:' "${UPRIGHT_APP_PATH}/config/deploy.yml"; }; then
  CERTIFICATE_PEM="$(read_secret_multiline ssl/certificate_pem CERTIFICATE_PEM || true)"
  PRIVATE_KEY_PEM="$(read_secret_multiline ssl/private_key_pem PRIVATE_KEY_PEM || true)"
  if [[ -z "${CERTIFICATE_PEM}" || -z "${PRIVATE_KEY_PEM}" ]]; then
    echo "[ERROR] SSL is enabled but certificate secrets are missing. Run ~/bin/setup-certbot-ssl or export CERTIFICATE_PEM/PRIVATE_KEY_PEM." >&2
    exit 1
  fi
fi

cat <<OUT
export KAMAL_REGISTRY_PASSWORD=$(printf %q "${KAMAL_REGISTRY_PASSWORD}")
export ADMIN_PASSWORD=$(printf %q "${ADMIN_PASSWORD}")
$( [[ -n "${CERTIFICATE_PEM}" ]] && printf 'export CERTIFICATE_PEM=%q\n' "${CERTIFICATE_PEM}" )
$( [[ -n "${PRIVATE_KEY_PEM}" ]] && printf 'export PRIVATE_KEY_PEM=%q\n' "${PRIVATE_KEY_PEM}" )
OUT
